<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pages/main/untw.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/CodingBobby/traktify/issues" target="_blank" class="menu-item" id="issues_link" >Bugs & Issues</a></h2><h2><a href="https://circleci.com/gh/CodingBobby/traktify" target="_blank" class="menu-item" id="build_link" >Build Log</a></h2><h2><a href="https://discord.gg/BJNAMcj" target="_blank" class="menu-item" id="discord_link" >Discord Server</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-api_.html">Internal API</a></li><li><a href="tutorial-contributing.html">Contributing</a></li><li><a href="tutorial-ipc.html">Internal Communication</a></li></ul><h3>Classes</h3><ul><li><a href="Modules.API.CachedTraktor.html">CachedTraktor</a><ul class='methods'><li data-type='method'><a href="Modules.API.CachedTraktor.html#cacheware">cacheware</a></li></ul></li><li><a href="Modules.API.Traktor.html">Traktor</a><ul class='methods'><li data-type='method'><a href="Modules.API.Traktor.html#availableMethods">availableMethods</a></li><li data-type='method'><a href="Modules.API.Traktor.html#execRequest">execRequest</a></li><li data-type='method'><a href="Modules.API.Traktor.html#extractSearchResultDetails">extractSearchResultDetails</a></li><li data-type='method'><a href="Modules.API.Traktor.html#hiddenShows">hiddenShows</a></li><li data-type='method'><a href="Modules.API.Traktor.html#itemSummary">itemSummary</a></li><li data-type='method'><a href="Modules.API.Traktor.html#latestActivities">latestActivities</a></li><li data-type='method'><a href="Modules.API.Traktor.html#movieImages">movieImages</a></li><li data-type='method'><a href="Modules.API.Traktor.html#postHistory">postHistory</a></li><li data-type='method'><a href="Modules.API.Traktor.html#postRating">postRating</a></li><li data-type='method'><a href="Modules.API.Traktor.html#showImages">showImages</a></li><li data-type='method'><a href="Modules.API.Traktor.html#showProgress">showProgress</a></li><li data-type='method'><a href="Modules.API.Traktor.html#traktSearch">traktSearch</a></li><li data-type='method'><a href="Modules.API.Traktor.html#watchedMovies">watchedMovies</a></li><li data-type='method'><a href="Modules.API.Traktor.html#watchedShows">watchedShows</a></li></ul></li><li><a href="Modules.Manager.Cache.html">Cache</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Cache.html#getKey">getKey</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#keyStatus">keyStatus</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#remove">remove</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#removeKey">removeKey</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#retrieve">retrieve</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#save">save</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#setKey">setKey</a></li></ul></li><li><a href="Modules.Manager.Queue.html">Queue</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Queue.html#_doTick">_doTick</a></li><li data-type='method'><a href="Modules.Manager.Queue.html#_duplicates">_duplicates</a></li><li data-type='method'><a href="Modules.Manager.Queue.html#add">add</a></li></ul></li><li><a href="Modules.Manager.SwitchBoard.html">SwitchBoard</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.SwitchBoard.html#on">on</a></li><li data-type='method'><a href="Modules.Manager.SwitchBoard.html#send">send</a></li></ul></li><li><a href="Modules.Manager.Task.html">Task</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Task.html#run">run</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Modules.html">Modules</a></li><li><a href="Modules.API.html">API</a><ul class='methods'><li data-type='method'><a href="Modules.API.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="Modules.API.html#.connectUser">connectUser</a></li><li data-type='method'><a href="Modules.API.html#.formatSearch">formatSearch</a></li><li data-type='method'><a href="Modules.API.html#.getAPIKeys">getAPIKeys</a></li><li data-type='method'><a href="Modules.API.html#.runWithTimer">runWithTimer</a></li><li data-type='method'><a href="Modules.API.html#.startsWithFilter">startsWithFilter</a></li></ul></li><li><a href="Modules.App.html">App</a><ul class='methods'><li data-type='method'><a href="Modules.App.html#.buildAppWindow">buildAppWindow</a></li><li data-type='method'><a href="Modules.App.html#.initFileStructure">initFileStructure</a></li><li data-type='method'><a href="Modules.App.html#.initGetListener">initGetListener</a></li><li data-type='method'><a href="Modules.App.html#.initLogListener">initLogListener</a></li><li data-type='method'><a href="Modules.App.html#.initSystemListener">initSystemListener</a></li><li data-type='method'><a href="Modules.App.html#.loadPage">loadPage</a></li><li data-type='method'><a href="Modules.App.html#.readConfig">readConfig</a></li><li data-type='method'><a href="Modules.App.html#.saveConfig">saveConfig</a></li><li data-type='method'><a href="Modules.App.html#.startApp">startApp</a></li></ul></li><li><a href="Modules.Manager.html">Manager</a></li><li><a href="Modules.Renderer.html">Renderer</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.html#.auth">auth</a></li><li data-type='method'><a href="Modules.Renderer.html#.browse">browse</a></li><li data-type='method'><a href="Modules.Renderer.html#.listen">listen</a></li><li data-type='method'><a href="Modules.Renderer.html#.tracer">tracer</a></li></ul></li><li><a href="Modules.Renderer.Get.html">Get</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.Get.html#.available">available</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.details">details</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.hidden">hidden</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.images">images</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.latest">latest</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.movies">movies</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.progress">progress</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.search">search</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.shows">shows</a></li></ul></li><li><a href="Modules.Renderer.Post.html">Post</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.Post.html#.history">history</a></li><li data-type='method'><a href="Modules.Renderer.Post.html#.rating">rating</a></li></ul></li><li><a href="Traktify.html">Traktify</a></li></ul><h3>Global</h3><ul><li><a href="global.html#alertError">alertError</a></li><li><a href="global.html#checkImage">checkImage</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#filterItems">filterItems</a></li><li><a href="global.html#getActionText">getActionText</a></li><li><a href="global.html#getProgressPercentage">getProgressPercentage</a></li><li><a href="global.html#initSlide">initSlide</a></li><li><a href="global.html#minutesToText">minutesToText</a></li><li><a href="global.html#parseEpisodeTitle">parseEpisodeTitle</a></li><li><a href="global.html#parseItemImage">parseItemImage</a></li><li><a href="global.html#requestUpdateDetails">requestUpdateDetails</a></li><li><a href="global.html#setActionButton">setActionButton</a></li><li><a href="global.html#setAlertbox">setAlertbox</a></li><li><a href="global.html#shuffleSlides">shuffleSlides</a></li><li><a href="global.html#toggleAlert">toggleAlert</a></li><li><a href="global.html#userLoading">userLoading</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">pages/main/untw.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>class UpNext {
  constructor() {}


  /**
   * Handles everything related to UNTW Tiles.
   * @param {HTMLElement} tile 
   * @param {object} [data] data is arranged in array as follow: [[showId, showTitle, epId], progress, nextEp, images]
   */
  tile(tile, data) {
    return new Tile(tile, data)  
  }


  /**
   * Updates show and episode name in UNTW.
   * @param {HTMLElement} tile 
   */
  static setText(tile) {
    let data = ['up next to watch', tile.dataset.untwTitle, tile.dataset.untwEpisodeTitle];

    Array.from(untw.children[0].children).forEach((elm, i) => {
      if (!data[i]) {
        elm.innerHTML = '';
        elm.setAttribute('loading', 'dark')
      } else {
        elm.innerHTML = data[i];
        if (elm.hasAttribute('loading')) {
          elm.removeAttribute('loading')
        }
      }    
    })
  }
}


class Tile {
  constructor(tile, data) {
    this.tile = tile || document.createElement('div');
    this.data = data ? {
      id: data[0][0],
      title: data[0][1],
      aired: data[1].aired,
      completed: data[1].completed,
      images: data[3],
      season: {
        number: data[2].season,
      },
      episode: {
        id: data[0][2],
        title: data[2].title,
        number: data[2].number,
        number_abs: data[2].number_abs,
        rating: data[2].rating.toFixed(1),
        runtime: data[2].runtime
      }
    } : null
  }


  /**
   * Responsible for setting the tile data and its functionality as a whole.
   * Tile states are: show, loading, empty
   * @param {string} state
   * @returns {HTMLElement}
   */
  set(state) {
    switch(state) {
      case 'show':
        this.tile.dataset.untwTitle = this.data.title;
        this.tile.dataset.untwEpisodeTitle = parseEpisodeTitle(this.data);

        this.tile.innerHTML = `
          &lt;div class="tileImg" style="--poster-img:url(${parseItemImage('poster', this.data)});background-image:url(${parseItemImage('banner', this.data)})">&lt;/div>
          &lt;div class="tileInfo">
            &lt;div class="fs16 fwSemiBold">
              &lt;div class="actions">
                &lt;div class="btn small">&lt;/div>
                &lt;div class="btn small">&lt;/div>
              &lt;/div>
              &lt;div class="rating">&lt;i class="icon-heart">&lt;/i> ${this.data.episode.rating}&lt;/div>
            &lt;/div>
            &lt;div class="progress" data-tooltip="${minutesToText(this.data.episode.runtime * this.data.completed)}-- ${this.data.completed}/${this.data.aired}">
              &lt;div style="width:${getProgressPercentage(this.data.completed, this.data.aired)}%">&lt;/div>
            &lt;/div>
          &lt;/div>
        `;
        
        this.tile.onmouseover = () => UpNext.setText(this.tile);
        this.tile.onmouseleave = (e) => {
          if (e.toElement &amp;&amp; e.toElement.closest('.alertContainer')) {
            return this.tile.querySelector('.tileInfo').style.bottom = 0
          }
        
          UpNext.setText(untw.children[1])
        };
        this.tile.onclick = (e) => {
          // opens epsiode for tile in poster format by clicking on image
          if (e.target == this.tile.children[0]) {
            console.log('show episode card')
          }

          // opens episode for tile in banner format, includes main tile as well.
          if (!e.target.closest('.actions') &amp;&amp; !e.target.closest('.progress') &amp;&amp; !e.target.closest('.rating')) {
            if (!e.target.closest('[untw-latest]')) {
              console.log('show episode card')
            } else if (e.target.closest('[untw-latest]') &amp;&amp; window.innerWidth &lt; 1000) {
              console.log('show episode card')
            }
          }
        };
        
        let confirm = (type) => {
          this.update(type)
          toggleAlert(actionAlerts, false);
        };

        let revert = () => {
          toggleAlert(actionAlerts, false)
          this.reset()
        };

        setActionButton(this.tile, 'play', this.data, false, () => confirm('play'), revert);
        setActionButton(this.tile, 'watchlist', this.data, true, () => confirm('watchlist'), revert);
        break;
      case 'loading':
        this.tile.innerHTML = '';
        this.tile.dataset.untwTitle = '';
        this.tile.dataset.untwEpisodeTitle = '';
        this.tile.setAttribute('loading', '');
        break;
      case 'empty':
        this.tile.style.backgroundColor = 'var(--watchlist)';
        this.tile.classList = 'shadow'
    }

    if (this.tile.hasAttribute('untw-latest')) {
      UpNext.setText(this.tile)
    }

    if (this.tile.hasAttribute('loading') &amp;&amp; state != 'loading') {
      this.tile.removeAttribute('loading')
    }

    return this.tile
  }

  
  /**
   * Replaces the selected tile with the one next to it.
   */
  next() {
    if (this.tile.hasAttribute('untw-latest')) {
      let nextTile = this.tile.nextElementSibling;
      nextTile.setAttribute('untw-latest', '');

      if (nextTile.dataset.untwId) {
        UpNext.setText(nextTile)
      }
    }
  
    this.tile.remove();
  
    // creates a new tile to fill in blanks
    let children = untw.children.length;
    if (children &lt; MAX_TILES + 1) {
      untw.appendChild(new Tile().set('empty'))
    }
  }


  /**
   * Resets tile from hover to default state.
   */
  reset() {
    this.tile.querySelector('.tileInfo').style = '';
    UpNext.setText(untw.children[1])
  }


  /**
   * Updates tile based on the interacted action.
   * @param {string} type
   */
  update(type) {
    if (type == 'history') {
      let showId = this.tile.dataset.untwId;
      // save show title before changing tile state to loading
      let showTitle = this.tile.dataset.untwTitle;

      this.set('loading');
      
      window.traktify.post.history({changes: {episodes: [{ids: {trakt: this.tile.dataset.untwEpisodeId}}]}}).then(() => {
        window.traktify.get.progress(showId, true).then(progress => {   
          // checks if the show is complete or not
          if (progress.aired == progress.completed) {
            this.next();
            return
          }
          
          let nextEp = progress.next_episode;
          let epId = nextEp.ids.trakt;
          this.tile.dataset.untwEpisodeId = epId;
          
          window.traktify.get.images({type: 'show', id: this.tile.dataset.untwTvdb}).then(images => {
            new Tile(this.tile, [
              [showId, showTitle, epId], progress, nextEp, images
            ]).set('show')
          })
        })
      })
    } else {
      // for now till other apis are available
      this.next()
    }
  }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a>.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
