<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>pages/communicator.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/CodingBobby/traktify/issues" target="_blank" class="menu-item" id="issues_link" >Bugs & Issues</a></h2><h2><a href="https://circleci.com/gh/CodingBobby/traktify" target="_blank" class="menu-item" id="build_link" >Build Log</a></h2><h2><a href="https://discord.gg/BJNAMcj" target="_blank" class="menu-item" id="discord_link" >Discord Server</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-api_.html">Internal API</a></li><li><a href="tutorial-contributing.html">Contributing</a></li><li><a href="tutorial-ipc.html">Internal Communication</a></li></ul><h3>Classes</h3><ul><li><a href="Modules.API.CachedTraktor.html">CachedTraktor</a><ul class='methods'><li data-type='method'><a href="Modules.API.CachedTraktor.html#cacheware">cacheware</a></li></ul></li><li><a href="Modules.API.Traktor.html">Traktor</a><ul class='methods'><li data-type='method'><a href="Modules.API.Traktor.html#availableMethods">availableMethods</a></li><li data-type='method'><a href="Modules.API.Traktor.html#execRequest">execRequest</a></li><li data-type='method'><a href="Modules.API.Traktor.html#extractSearchResultDetails">extractSearchResultDetails</a></li><li data-type='method'><a href="Modules.API.Traktor.html#hiddenShows">hiddenShows</a></li><li data-type='method'><a href="Modules.API.Traktor.html#itemSummary">itemSummary</a></li><li data-type='method'><a href="Modules.API.Traktor.html#latestActivities">latestActivities</a></li><li data-type='method'><a href="Modules.API.Traktor.html#movieImages">movieImages</a></li><li data-type='method'><a href="Modules.API.Traktor.html#postHistory">postHistory</a></li><li data-type='method'><a href="Modules.API.Traktor.html#postRating">postRating</a></li><li data-type='method'><a href="Modules.API.Traktor.html#showImages">showImages</a></li><li data-type='method'><a href="Modules.API.Traktor.html#showProgress">showProgress</a></li><li data-type='method'><a href="Modules.API.Traktor.html#traktSearch">traktSearch</a></li><li data-type='method'><a href="Modules.API.Traktor.html#watchedMovies">watchedMovies</a></li><li data-type='method'><a href="Modules.API.Traktor.html#watchedShows">watchedShows</a></li></ul></li><li><a href="Modules.Manager.Cache.html">Cache</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Cache.html#getKey">getKey</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#keyStatus">keyStatus</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#remove">remove</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#removeKey">removeKey</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#retrieve">retrieve</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#save">save</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#setKey">setKey</a></li></ul></li><li><a href="Modules.Manager.Queue.html">Queue</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Queue.html#_doTick">_doTick</a></li><li data-type='method'><a href="Modules.Manager.Queue.html#_duplicates">_duplicates</a></li><li data-type='method'><a href="Modules.Manager.Queue.html#add">add</a></li></ul></li><li><a href="Modules.Manager.SwitchBoard.html">SwitchBoard</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.SwitchBoard.html#on">on</a></li><li data-type='method'><a href="Modules.Manager.SwitchBoard.html#send">send</a></li></ul></li><li><a href="Modules.Manager.Task.html">Task</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Task.html#run">run</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Modules.html">Modules</a></li><li><a href="Modules.API.html">API</a><ul class='methods'><li data-type='method'><a href="Modules.API.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="Modules.API.html#.connectUser">connectUser</a></li><li data-type='method'><a href="Modules.API.html#.formatSearch">formatSearch</a></li><li data-type='method'><a href="Modules.API.html#.getAPIKeys">getAPIKeys</a></li><li data-type='method'><a href="Modules.API.html#.runWithTimer">runWithTimer</a></li><li data-type='method'><a href="Modules.API.html#.startsWithFilter">startsWithFilter</a></li></ul></li><li><a href="Modules.App.html">App</a><ul class='methods'><li data-type='method'><a href="Modules.App.html#.buildAppWindow">buildAppWindow</a></li><li data-type='method'><a href="Modules.App.html#.initFileStructure">initFileStructure</a></li><li data-type='method'><a href="Modules.App.html#.initGetListener">initGetListener</a></li><li data-type='method'><a href="Modules.App.html#.initLogListener">initLogListener</a></li><li data-type='method'><a href="Modules.App.html#.initSystemListener">initSystemListener</a></li><li data-type='method'><a href="Modules.App.html#.loadPage">loadPage</a></li><li data-type='method'><a href="Modules.App.html#.readConfig">readConfig</a></li><li data-type='method'><a href="Modules.App.html#.saveConfig">saveConfig</a></li><li data-type='method'><a href="Modules.App.html#.startApp">startApp</a></li></ul></li><li><a href="Modules.Manager.html">Manager</a></li><li><a href="Modules.Renderer.html">Renderer</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.html#.auth">auth</a></li><li data-type='method'><a href="Modules.Renderer.html#.browse">browse</a></li><li data-type='method'><a href="Modules.Renderer.html#.listen">listen</a></li><li data-type='method'><a href="Modules.Renderer.html#.tracer">tracer</a></li></ul></li><li><a href="Modules.Renderer.Get.html">Get</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.Get.html#.available">available</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.details">details</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.hidden">hidden</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.images">images</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.latest">latest</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.movies">movies</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.progress">progress</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.search">search</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.shows">shows</a></li></ul></li><li><a href="Modules.Renderer.Post.html">Post</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.Post.html#.history">history</a></li><li data-type='method'><a href="Modules.Renderer.Post.html#.rating">rating</a></li></ul></li><li><a href="Traktify.html">Traktify</a></li></ul><h3>Global</h3><ul><li><a href="global.html#alertError">alertError</a></li><li><a href="global.html#checkImage">checkImage</a></li><li><a href="global.html#createSlide">createSlide</a></li><li><a href="global.html#delay">delay</a></li><li><a href="global.html#filterItems">filterItems</a></li><li><a href="global.html#getProgressPercentage">getProgressPercentage</a></li><li><a href="global.html#minutesToText">minutesToText</a></li><li><a href="global.html#parseEpisodeTitle">parseEpisodeTitle</a></li><li><a href="global.html#parseItemImage">parseItemImage</a></li><li><a href="global.html#playSlides">playSlides</a></li><li><a href="global.html#requestUpdateDetails">requestUpdateDetails</a></li><li><a href="global.html#resetTile">resetTile</a></li><li><a href="global.html#setAlertbox">setAlertbox</a></li><li><a href="global.html#setTextUNTW">setTextUNTW</a></li><li><a href="global.html#setTileActionButton">setTileActionButton</a></li><li><a href="global.html#setTileData">setTileData</a></li><li><a href="global.html#shuffleArray">shuffleArray</a></li><li><a href="global.html#toggleAlert">toggleAlert</a></li><li><a href="global.html#updateNextTile">updateNextTile</a></li><li><a href="global.html#userLoading">userLoading</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">pages/communicator.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * API available to the render process.
 * It is preloaded into all pages and makes communication with the main node process possible.
 * Methods and constants are exposed through `window.traktify`.
 * Note: Logging must also be channelled through this because otherwise messages would only appear in the dev-tools and not in the terminal or in log files.
 * @namespace Renderer
 * @memberof Modules
 * @example // log like this instead of using `console.log`
 * window.traktify.tracer({ level: 'warn', msg: 'to get attention' })
 */


const { contextBridge } = require('electron')
const { SwitchBoard } = require('../modules/manager/ipc.js')
const { formatSearch } = require('../modules/api/filters.js')

const SB = new SwitchBoard()


// listens for messages coming from the backend
SB.on('report.progress', (data, done) => {
  // data: { fraction: 0...1, message: string }

  API.tracer({ lvl: 'info', msg: `progress: ${Math.round(data.fraction*100)} %` })
  API.tracer({ lvl: 'info', msg: `working on: ${data.message}` })

  done()
})


const API = {

  /**
   * Routes to the actual {@link Modules.Manager.tracer} instance of the main process for logging on the same level.
   * @param {Object} data 
   * @param {string} data.msg the log message
   * @param {Modules.Manager.LogLevel} data.lvl log-level
   * @memberof Modules.Renderer
   */
  tracer: data => {
    SB.send('tracer', data)
  },


  /**
   * Request a link and user-code for authentication in an external browser.
   * @returns {Promise.&lt;Modules.API.TRAKT_AUTH_POLL>}
   * @memberof Modules.Renderer
   */
  auth: () => {
    return SB.send('request.authpoll', '')
  },


  /**
   * Open an external link with the computer's default browser.
   * @param {string} link url to open
   * @returns {void}
   * @memberof Modules.Renderer
   */
  browse: link => {
    SB.send('request.openexternal', link)
  },


  /**
   * Initialises an IPC listener using {@link Modules.Manager.SwitchBoard}.
   * @param {string} channel route to listen on
   * @param {function} callback fires when message is received
   * @returns {void}
   * @memberof Modules.Renderer
   * @example // waiting for reports about loading progress
   * window.traktify.listen('report.progress', details => {
   *   // log details to developer console
   *   console.log('progress:', Math.round(details.fraction*100), '%')
   *   console.log('working on:', details.message)
   * })
   */
  listen: (channel, callback) => {
    SB.on(channel, (data, done) => {
      done()
      callback(data)
    })
  },


  /**
   * Get a list of files and directories existing at a given path.
   * @param {string} path `.` refers to the repo's base
   * @returns {Promise.&lt;Array.&lt;string>>}
   */
  files: path => {
    return SB.send('request.filelist', path)
  },


  /**
   * Execute any API method even when it is not included in {@link Modules.API.Traktor} yet.
   * @param {Object} query
   * @param {string} query.path method.path.like.this
   * @param {Object} query.args anything that would be passed to the method
   * @param {boolean} [overwrite] whether to bypass the cache
   * @returns {*}
   * @example window.traktify.exec({
   *   path: 'trakt.shows.next_episode',
   *   args: {
   *     id: 10887
   *   }
   * })
   */
  exec: query => {
    return SB.send('get', {
      method: 'execRequest',
      query,
      overwrite
    })
  },


  /**
   * Get requests wrapping the trakt.tv API.
   * @namespace Get
   * @memberof Modules.Renderer
   */

  /**
   * @type {Object.&lt;string,Function>}
   * @memberof Modules.Renderer
   */
  get: {

    /**
     * Searches the trakt.tv database and allows shortcuts within the search string.
     * @param {string} query search string
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Array.&lt;Modules.API.TRAKT_SEARCH_OBJECT>>} resolves a list of objects
     * @example window.traktify.get.search('m:inception')
     * @memberof Modules.Renderer.Get
     */
    search: (query, overwrite) => {
      return SB.send('get', {
        method: 'traktSearch',
        query: formatSearch(query),
        overwrite
      })
    },


    /**
     * Get a summary of the latest activities of the user in each (sub)category.
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Modules.API.TRAKT_ACTIVITY_OBJECT>}
     * @memberof Modules.Renderer.Get
     */
    latest: overwrite => {
      return SB.send('get', {
        method: 'latestActivities',
        overwrite
      })
    },


    /**
     * Lists the methods trakt.js offers.
     * Note: These are *not* available through the internal API directly.
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Array.&lt;string>>}
     * @memberof Modules.Renderer.Get
     */
    available: overwrite => {
      return SB.send('get', {
        method: 'availableMethods',
        overwrite
      })
    },


    /**
     * Get a list of shows the user started (and finished) to watch.
     * Results can be used for up-next or history dashboards.
     * The default removes hidden and finished shows from that list, but these filters can be turned off with the `options` parameters.
     * Filtering is done here and not on the backend of the API because the filtered result doesn't need to be cached.
     * Can be used in combination with {@link Modules.Renderer.Get.progress} to get a fully detailed list of upcoming episodes.
     * @param {Object} [options]
     * @param {boolean} [options.includeHidden] removes hidden items when false
     * @param {boolean} [options.includeFinished] removes finished items when false
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Array.&lt;Modules.API.TRAKT_WATCHED_SHOW>>}
     * @memberof Modules.Renderer.Get
     */
    shows: (options, overwrite) => {
      options = options ?? {}

      return SB.send('get', {
        method: 'watchedShows',
        overwrite
      }).then(async all => {
        if (!options.includeHidden) {
          return await SB.send('get', {
            method: 'hiddenShows',
            overwrite
          }).then(hidden => {
            // get a list of IDs to compare
            let hiddenIDs = hidden.map(item => item.show.ids.trakt)

            return all.filter(item => {
              // only keep shows that were not hidden
              return !hiddenIDs.includes(item.show.ids.trakt)
            })
          })
        }

        // when options.includeHidden === true
        return all
      }).then(pre => {
        if (!options.includeFinished) {
          return pre.filter(item => {
            // count episodes that appear in watched structure
            let watchedEpisodes = 0
            item.seasons.forEach(season => {
              watchedEpisodes += season.episodes.length
            })

            // only keep show when it has more episodes than the user has watched
            return item.show.aired_episodes > watchedEpisodes
          })
        }

        // when options.includeFinished === true
        if (!{}.rick?.({}.ashley?.('gives you up'))) {
          return pre
        }
      })
    },


    /**
     * Get information about the progress a user has for a single show.
     * Includes details about last watched episode and the next one coming up.
     * Useful for various dashboards.
     * @param {number} showID identifier formatted as trakt
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Array.&lt;Modules.API.TRAKT_SHOW_PROGRESS>>}
     * @memberof Modules.Renderer.Get
     * @example window.traktify.get.shows().then(shows => {
     *   // get details of first 5 items
     *   for (let i=0; i&lt;5; i++) {
     *     let show = shows[i].show
     *     let showID = show.ids.trakt
     * 
     *     traktify.get.progress(showID).then(progress => {
     *       // summary of show
     *       console.log(show)
     * 
     *       // summary of next episode
     *       console.log(progress.next_episode)
     *     })
     *   }
     * })
     */
    progress: (showID, overwrite) => {
      return SB.send('get', {
        method: 'showProgress',
        query: {
          id: showID
        },
        overwrite
      })
    },


    /**
     * Get a list of movies the user watched at least once.
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Array.&lt;Modules.API.TRAKT_WATCHED_MOVIE>>}
     * @memberof Modules.Renderer.Get
     */
    movies: overwrite => {
      return SB.send('get', {
        method: 'watchedMovies',
        overwrite
      })
    },


    /**
     * Get a list of shows the user wishes to hide from the progress table.
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Array.&lt;Modules.API.TRAKT_HIDDEN_SHOW>>}
     * @memberof Modules.Renderer.Get
     */
    hidden: overwrite => {
      return SB.send('get', {
        method: 'hiddenShows',
        overwrite
      })
    },


    /**
     * Get all details known for a specific item.
     * Even though the IDs are unique, the target type is required because of the way the trakt API works.
     * @param {Object} query
     * @param {'movie'|'show'|'episode'|'person'} query.type
     * @param {number} query.id identification number in trakt format
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Modules.API.TRAKT_ITEM_DETAILS>}
     * @memberof Modules.Renderer.Get
     * @example window.traktify.get.details({
     *   type: 'movie',
     *   id: 796
     * })
     */
    details: (query, overwrite) => {
      return SB.send('get', {
        method: 'itemSummary',
        query,
        overwrite
      })
    },


    /**
     * Get a list of images available for a show or movie.
     * Pay attention, as the tvdb-id is required here, *not* trakt.
     * @param {Object} query
     * @param {'movie'|'show'} query.type
     * @param {number} query.id identifier in TVDB format
     * @param {boolean} [overwrite] whether to bypass the cache
     * @returns {Promise.&lt;Modules.API.FANART_MOVIE_IMAGES|Modules.API.FANART_SHOW_IMAGES>}
     * @memberof Modules.Renderer.Get
     */
    images: (query, overwrite) => {
      return SB.send('get', {
        method: `${query.type}Images`,
        query,
        overwrite
      })
    }
  },


  /**
   * Post requests wrapping the trakt.tv API.
   * @namespace Post
   * @memberof Modules.Renderer
   */

  /**
   * @type {Object.&lt;string,Function>}
   * @memberof Modules.Renderer
   */
  post: {

    /**
     * Upload one or multiple history updates.
     * @param {Object} query
     * @param {Object} query.changes
     * @param {Array.&lt;Modules.API.TRAKT_HISTORY_POST>} query.changes.movies
     * @param {Array.&lt;Modules.API.TRAKT_HISTORY_POST>} query.changes.episodes
     * @param {Array} query.changes.shows
     * @param {Array} query.changes.seasons
     * @returns {Promise.&lt;Modules.API.TRAKT_POST_RESULT>}
     * @memberof Modules.Renderer.Post
     */
    history: query => {
      return SB.send('post', {
        method: 'postHistory', 
        query
      })
    },

    
    /**
     * Upload one or multiple rating updates.
     * @param {Object} query
     * @param {Object} query.changes
     * @param {Array.&lt;Modules.API.TRAKT_RATING_POST>} query.changes.movies
     * @param {Array.&lt;Modules.API.TRAKT_RATING_POST>} query.changes.episodes
     * @param {Array} query.changes.shows
     * @param {Array} query.changes.seasons
     * @returns {Promise.&lt;Modules.API.TRAKT_POST_RESULT>}
     * @memberof Modules.Renderer.Post
     */
    rating: query => {
      return SB.send('post', {
        method: 'postRating', 
        query
      })
    }
  }

}


// Why isn't this called `exposeInRenderWorld`? It's not the main process!
contextBridge.exposeInMainWorld('traktify', API)
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a>.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
