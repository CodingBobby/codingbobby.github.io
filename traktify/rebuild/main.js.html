<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>main.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/CodingBobby/traktify/issues" target="_blank" class="menu-item" id="issues_link" >Bugs & Issues</a></h2><h2><a href="https://circleci.com/gh/CodingBobby/traktify" target="_blank" class="menu-item" id="build_link" >Build Log</a></h2><h2><a href="https://discord.gg/BJNAMcj" target="_blank" class="menu-item" id="discord_link" >Discord Server</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-api.html">Internal API</a></li><li><a href="tutorial-contributing.html">Contributing</a></li><li><a href="tutorial-ipc.html">Internal Communication</a></li></ul><h3>Classes</h3><ul><li><a href="Modules.API.CachedTraktor.html">CachedTraktor</a><ul class='methods'><li data-type='method'><a href="Modules.API.CachedTraktor.html#cacheware">cacheware</a></li></ul></li><li><a href="Modules.API.Traktor.html">Traktor</a><ul class='methods'><li data-type='method'><a href="Modules.API.Traktor.html#availableMethods">availableMethods</a></li><li data-type='method'><a href="Modules.API.Traktor.html#extractSearchResultDetails">extractSearchResultDetails</a></li><li data-type='method'><a href="Modules.API.Traktor.html#latestActivities">latestActivities</a></li><li data-type='method'><a href="Modules.API.Traktor.html#traktSearch">traktSearch</a></li></ul></li><li><a href="Modules.Manager.Cache.html">Cache</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Cache.html#getKey">getKey</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#keyStatus">keyStatus</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#remove">remove</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#removeKey">removeKey</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#retrieve">retrieve</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#save">save</a></li><li data-type='method'><a href="Modules.Manager.Cache.html#setKey">setKey</a></li></ul></li><li><a href="Modules.Manager.Queue.html">Queue</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Queue.html#_doTick">_doTick</a></li><li data-type='method'><a href="Modules.Manager.Queue.html#_duplicates">_duplicates</a></li><li data-type='method'><a href="Modules.Manager.Queue.html#add">add</a></li></ul></li><li><a href="Modules.Manager.SwitchBoard.html">SwitchBoard</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.SwitchBoard.html#on">on</a></li><li data-type='method'><a href="Modules.Manager.SwitchBoard.html#send">send</a></li></ul></li><li><a href="Modules.Manager.Task.html">Task</a><ul class='methods'><li data-type='method'><a href="Modules.Manager.Task.html#run">run</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="Modules.html">Modules</a></li><li><a href="Modules.API.html">API</a><ul class='methods'><li data-type='method'><a href="Modules.API.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="Modules.API.html#.connectUser">connectUser</a></li><li data-type='method'><a href="Modules.API.html#.formatSearch">formatSearch</a></li><li data-type='method'><a href="Modules.API.html#.getAPIKeys">getAPIKeys</a></li><li data-type='method'><a href="Modules.API.html#.startsWithFilter">startsWithFilter</a></li></ul></li><li><a href="Modules.App.html">App</a><ul class='methods'><li data-type='method'><a href="Modules.App.html#.buildAppWindow">buildAppWindow</a></li><li data-type='method'><a href="Modules.App.html#.initFileStructure">initFileStructure</a></li><li data-type='method'><a href="Modules.App.html#.initGetListener">initGetListener</a></li><li data-type='method'><a href="Modules.App.html#.initLogListener">initLogListener</a></li><li data-type='method'><a href="Modules.App.html#.initSystemListener">initSystemListener</a></li><li data-type='method'><a href="Modules.App.html#.loadPage">loadPage</a></li><li data-type='method'><a href="Modules.App.html#.readConfig">readConfig</a></li><li data-type='method'><a href="Modules.App.html#.saveConfig">saveConfig</a></li><li data-type='method'><a href="Modules.App.html#.startApp">startApp</a></li></ul></li><li><a href="Modules.Manager.html">Manager</a></li><li><a href="Modules.Renderer.html">Renderer</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.html#.auth">auth</a></li><li data-type='method'><a href="Modules.Renderer.html#.browse">browse</a></li><li data-type='method'><a href="Modules.Renderer.html#.listen">listen</a></li><li data-type='method'><a href="Modules.Renderer.html#.tracer">tracer</a></li></ul></li><li><a href="Modules.Renderer.Get.html">Get</a><ul class='methods'><li data-type='method'><a href="Modules.Renderer.Get.html#.available">available</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.latest">latest</a></li><li data-type='method'><a href="Modules.Renderer.Get.html#.search">search</a></li></ul></li><li><a href="Traktify.html">Traktify</a></li></ul><h3>Global</h3><ul><li><a href="global.html#requestUpdateDetails">requestUpdateDetails</a></li><li><a href="global.html#userLoading">userLoading</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">main.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 *        .....                                         ..           s       .
 *     .H8888888h.  ~-.                           &lt; .z@8"`          :8      @88>     oec :    ..
 *     888888888888x  `>    .u    .                !@88E           .88      %8P     @88888   @L
 *    X~     `?888888hx~  .d88B :@8c        u      '888E   u      :888ooo    .      8"*88%  9888i   .dL
 *    '      x8.^"*88*"  ="8888f8888r    us888u.    888E u@8NL  -*8888888  .@88u    8b.     `Y888k:*888.
 *     `-:- X8888x         4888>'88"  .@88 "8888"   888E`"88*"    8888    ''888E`  u888888>   888E  888I
 *          488888>        4888> '    9888  9888    888E .dN.     8888      888E    8888R     888E  888I
 *        .. `"88*         4888>      9888  9888    888E~8888     8888      888E    8888P     888E  888I
 *      x88888nX"      .  .d888L .+   9888  9888    888E '888&amp;   .8888Lu=   888E    *888>     888E  888I
 *     !"*8888888n..  :   ^"8888*"    9888  9888    888E  9888.  ^%888*     888&amp;    4888     x888N>&lt;888'
 *    '    "*88888888*       "Y"      "888*""888" '"888*" 4888"    'Y"      R888"   '888      "88"  888
 *            ^"***"`                  ^Y"   ^Y'     ""    ""                ""      88R            88F
 *                                                                                   88>           98"
 * is a desktop app for trakt.tv                                                     48          ./"
 * created by @CodingBobby and @Bumbleboss in 2019                                   '8         ~`
 * using the trakt api with the trakt.js library
 * in an electron framework
 */


/**
 * Main process executed at app-start.
 * @namespace Traktify
 */
/**
 * Collection of methods, classes and objects that are used by the main.
 * @namespace Modules
 */
/**
 * Entry point of the electron.js app.
 * Defines windows and listeners.
 * @namespace App
 * @memberof Modules
 */
/**
 * Methods and utilities related to API requests.
 * For details on the trakt.tv API, see {@link https://github.com/vankasteelj/trakt.tv/blob/master/docs/available_methods.md}.
 * @namespace API
 * @memberof Modules
 */
/**
 * Task management and automation.
 * @namespace Manager
 * @memberof Modules
 */


/**
 * Unix-time of initialisation.
 * @type {number}
 * @memberof Traktify
 */
const INIT_TIME = Date.now()
process.env.INIT_TIME = INIT_TIME


/**
 * Path to src/ which is parent to all files.
 * @type {string}
 * @memberof Traktify
 */
const BASE_PATH = __dirname
process.env.BASE_PATH = BASE_PATH


const tracer = require('./modules/manager/log.js')
const { SwitchBoard } = require('./modules/manager/ipc.js')
const { startApp, loadPage, userLoading } = require('./modules/app/start.js')
const {
  initLogListener,
  initGetListener,
  initSystemListener
} = require('./modules/app/listener.js')
const { getAPIKeys } = require('./modules/api/init.js')
const { initFileStructure, readConfig } = require('./modules/app/files.js')
const { connectUser, authenticateUser } = require('./modules/api/auth.js')

startApp(appWindow => {
  // loading window is ready for content to be rendered

  loadPage({
    window: appWindow,
    page: 'loading'
  }, () => {
    const steps = 4 // tasks to complete in this callback

    // open communication channel with render process
    const SB = new SwitchBoard({ window: appWindow })

    // make tracer available for the window
    initLogListener(SB)
    // other essential methods
    initSystemListener(SB)

    // tell frontend what is going on
    // yes, it's a Promise but not essential to wait for
    SB.send('report.progress', {
      fraction: 0/steps,
      message: 'checking API keys'
    })

    // check the API keys
    getAPIKeys()

    SB.send('report.progress', {
      fraction: 1/steps,
      message: 'checking file setup'
    })

    // check/fix the local file structure
    initFileStructure().then((_PATHS, rejected) => {
      // will only get rejected if files cannot be written or read
      if (rejected) {
        tracer.error(rejected)
        return
      }

      SB.send('report.progress', {
        fraction: 2/steps,
        message: 'looking for trakt.tv user'
      })

      // check if user exists in config
      const CONFIG = readConfig()

      if (CONFIG.user.trakt.auth) {
        tracer.log('found existing user')
        
        SB.send('report.progress', {
          fraction: 3/steps,
          message: 'trying to authenticate'
        })

        // try to authenticate
        authenticateUser(trakt => {
          startLoading(trakt, false)
        }, () => {
          // connecting user didn't work, potentially because of revokation
          // TODO: remove auth codes from config and load login page
        })

      } else {
        tracer.log('no user found')
        SB.send('report.progress', {
          fraction: 3/steps,
          message: 'proceeding to login'
        })

        // functionalised for possibility to reload
        function enterLogin() {
          loadPage({
            window: appWindow,
            page: 'login'
          }, () => {})
        }

        // wait for user requesting a login poll
        SB.on('request.authpoll', (_data, done) => {
          tracer.log('poll request received')

          connectUser(poll => {
            // send poll details back so user can authenticate
            done(poll)

          }, trakt => {
            // user is connected and loading can proceed with user-specific things
            loadPage({
              window: appWindow,
              page: 'loading'
            }, () => {
              startLoading(trakt, true)
            })

          }, () => {
            // login didn't work, so reload page
            enterLogin()
          })

        })

        enterLogin()
      }

      /**
       * @param {Trakt} trakt authenticated trakt.tv instance
       * @param {boolean} firstTime if user was logged in for the first time
       */
      async function startLoading(trakt, firstTime) {
        // user is now connected
        // wait for it because it would otherwise appear in the loading screen below
        await SB.send('report.progress', {
          fraction: 4/steps,
          message: 'connecting to APIs'
        })

        // enable renderer to ask for requests
        // this listener should remain active
        initGetListener(trakt, SB)

        // loading can proceed with user-specific things
        userLoading(trakt, SB, () => {
          loadPage({
            window: appWindow,
            page: 'main'
          }, () => {})
        })
      }

    })

  })

})
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated with <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a>.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
